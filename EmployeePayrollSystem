CREATE OR REPLACE PACKAGE payroll_pkg AS
   -- Global constant
   company_bonus CONSTANT NUMBER := 500;

   -- Custom exception
   e_emp_not_found EXCEPTION;

   -- Function to calculate gross salary
   FUNCTION calc_gross_salary(p_emp_id IN NUMBER) RETURN NUMBER;

   -- Function to calculate net salary
   FUNCTION calc_net_salary(p_emp_id IN NUMBER) RETURN NUMBER;

   -- Procedure to update salary components
   PROCEDURE update_salary(p_emp_id IN NUMBER, p_hra IN NUMBER, p_da IN NUMBER);

   -- Procedure to log salary actions
   PROCEDURE log_salary_action(p_emp_id IN NUMBER, p_action IN VARCHAR2);
END payroll_pkg;
/

CREATE OR REPLACE PACKAGE BODY payroll_pkg AS

   -- Function: Calculate gross salary
   FUNCTION calc_gross_salary(p_emp_id IN NUMBER) RETURN NUMBER IS
      v_basic  Employees.basic_salary%TYPE;
      v_hra    Employees.hra%TYPE;
      v_da     Employees.da%TYPE;
      v_gross  NUMBER;
   BEGIN
      -- Fetch salary components
      SELECT basic_salary, hra, da
      INTO v_basic, v_hra, v_da
      FROM Employees
      WHERE emp_id = p_emp_id;

      v_gross := v_basic + v_hra + v_da + company_bonus;
      RETURN v_gross;

   EXCEPTION
      WHEN NO_DATA_FOUND THEN
         RAISE e_emp_not_found;
   END calc_gross_salary;

   -----------------------------------------------------

   -- Function: Calculate net salary
   FUNCTION calc_net_salary(p_emp_id IN NUMBER) RETURN NUMBER IS
      v_deductions Employees.deductions%TYPE;
      v_gross NUMBER;
      v_net NUMBER;
   BEGIN
      v_gross := calc_gross_salary(p_emp_id);  -- call previous function

      SELECT deductions INTO v_deductions
      FROM Employees
      WHERE emp_id = p_emp_id;

      v_net := v_gross - v_deductions;
      RETURN v_net;

   EXCEPTION
      WHEN NO_DATA_FOUND THEN
         RAISE e_emp_not_found;
   END calc_net_salary;

   -----------------------------------------------------

   -- Procedure: Update salary components (HRA and DA)
   PROCEDURE update_salary(p_emp_id IN NUMBER, p_hra IN NUMBER, p_da IN NUMBER) IS
   BEGIN
      UPDATE Employees
      SET hra = p_hra, da = p_da
      WHERE emp_id = p_emp_id;

      IF SQL%ROWCOUNT = 0 THEN
         RAISE e_emp_not_found;
      END IF;

      DBMS_OUTPUT.put_line('Salary updated successfully for Employee ID: ' || p_emp_id);
   END update_salary;

   -----------------------------------------------------

   -- Procedure: Log salary action
   PROCEDURE log_salary_action(p_emp_id IN NUMBER, p_action IN VARCHAR2) IS
      v_new_log_id NUMBER;
   BEGIN
      SELECT NVL(MAX(log_id),0) + 1 INTO v_new_log_id FROM Payroll_Log;

      INSERT INTO Payroll_Log (log_id, emp_id, action, log_date)
      VALUES (v_new_log_id, p_emp_id, p_action, SYSDATE);

      DBMS_OUTPUT.put_line('Action logged for Employee ID: ' || p_emp_id || ' - ' || p_action);
   END log_salary_action;

END payroll_pkg;
/

DECLARE
   v_gross NUMBER;
   v_net   NUMBER;
BEGIN
   DBMS_OUTPUT.put_line('--- VALID EMPLOYEE TEST ---');

   -- Calculate Gross and Net Salary for employee 101
   v_gross := payroll_pkg.calc_gross_salary(101);
   v_net := payroll_pkg.calc_net_salary(101);

   DBMS_OUTPUT.put_line('Employee 101 Gross Salary: ' || v_gross);
   DBMS_OUTPUT.put_line('Employee 101 Net Salary:   ' || v_net);

   -- Update salary and log action
   payroll_pkg.update_salary(101, 5500, 3200);
   payroll_pkg.log_salary_action(101, 'Salary Updated');

   DBMS_OUTPUT.put_line('--- INVALID EMPLOYEE TEST ---');

   -- Try with an invalid employee ID (will raise exception)
   v_gross := payroll_pkg.calc_gross_salary(9999);

EXCEPTION
   WHEN payroll_pkg.e_emp_not_found THEN
      DBMS_OUTPUT.put_line('Error: Employee not found!');
END;
/
